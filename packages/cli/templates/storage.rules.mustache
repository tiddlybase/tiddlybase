rules_version = '2';
service firebase.storage {
    match /b/{bucket}/o {

      match /{instance}/{collection}/{allPaths=**}{

        function hasMinAccess(minAccessLevel) {
          let permissions = firestore.get(/databases/(default)/documents/tiddlybase-instances/admin/collections/instances/tiddlers/$(instance)).data.tiddler.permissions;
          return int(permissions[request.auth.uid]["files"][collection]) >= minAccessLevel;
        }
        allow read: if request.auth != null && hasMinAccess(1);
        allow create, update, delete: if request.auth != null && hasMinAccess(2);
        allow list: if request.auth != null && hasMinAccess(3);
      }
    }
}
